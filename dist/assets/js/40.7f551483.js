(window.webpackJsonp=window.webpackJsonp||[]).push([[40],{562:function(s,a,e){"use strict";e.r(a);var n=e(6),t=Object(n.a)({},(function(){var s=this,a=s.$createElement,e=s._self._c||a;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h1",{attrs:{id:"存储过程"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#存储过程"}},[s._v("#")]),s._v(" 存储过程")]),s._v(" "),e("h2",{attrs:{id:"_1-创建"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-创建"}},[s._v("#")]),s._v(" 1.创建")]),s._v(" "),e("h3",{attrs:{id:"无参数存储过程"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#无参数存储过程"}},[s._v("#")]),s._v(" 无参数存储过程")]),s._v(" "),e("div",{staticClass:"language-mysql line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("DELIMITER //\n CREATE PROCEDURE GetAllTest()\n   BEGIN\n   SELECT *  FROM test;\n   END //\nDELIMITER ;\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("p",[e("code",[s._v("DELIMITER //")]),s._v("，它与存储过程语法无关。"),e("code",[s._v("DELIMITER")]),s._v("语句将标准分隔符 - 分号("),e("code",[s._v(";")]),s._v(")更改为："),e("code",[s._v("//")]),s._v("。\n默认情况下，delimiter是分号**;**。在命令行客户端中，如果有一行命令以分号结束，\n那么回车后，mysql将会执行该命令。")]),s._v(" "),e("p",[s._v("但有时候，不希望MySQL这么做。在存储过程中可能输入较多的语句，且语句中包含有分号，所以需要DELIMITER")]),s._v(" "),e("p",[s._v("使用"),e("code",[s._v("CREATE PROCEDURE")]),s._v("语句创建一个新的存储过程，在这个示例中，存储过程的名称为："),e("code",[s._v("GetAllTest")]),s._v("。")]),s._v(" "),e("p",[e("code",[s._v("BEGIN")]),s._v("和"),e("code",[s._v("END")]),s._v("之间的部分称为存储过程的主体。将声明性SQL语句放在主体中以处理业务逻辑。 在这个存储过程中，我们使用一个简单的SELECT来查询test表中的数据。")]),s._v(" "),e("div",{staticClass:"language-mysql line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("CALL GetAllTest();\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("可以使用CALL调用它。")]),s._v(" "),e("h3",{attrs:{id:"in参数存储过程"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#in参数存储过程"}},[s._v("#")]),s._v(" IN参数存储过程")]),s._v(" "),e("p",[e("strong",[s._v("IN")]),s._v(" 表示这个存储过程需要需要的参数")]),s._v(" "),e("div",{staticClass:"language-mysql line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("DELIMITER //\n CREATE PROCEDURE GetAllTest(IN in_logid INT)\n   BEGIN\n   SELECT *  FROM test WHERE logid=in_logid;\n   END //\nDELIMITER ;\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("p",[s._v("使用CALL调用")]),s._v(" "),e("div",{staticClass:"language-mysql line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v(" CALL GetAllTest(2);\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("h3",{attrs:{id:"out参数存储过程"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#out参数存储过程"}},[s._v("#")]),s._v(" OUT参数存储过程")]),s._v(" "),e("div",{staticClass:"language-mysql line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("DELIMITER //\n CREATE PROCEDURE GetAllTest(OUT out_name  VARCHAR(20))\n   BEGIN\n   SELECT realname INTO out_name FROM test;\n   END //\nDELIMITER ;\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("p",[e("strong",[s._v("调用out的存储过程")])]),s._v(" "),e("div",{staticClass:"language-mysql line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v(" /*调用c的存储过程 out是输出，所以调用存储过程时这是一个变量@name*/\nCALL GetAllTest(@name);\n# 然后显示值\nSELECT @name\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("h3",{attrs:{id:"inout参数存储过程说明"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#inout参数存储过程说明"}},[s._v("#")]),s._v(" INOUT参数存储过程说明")]),s._v(" "),e("p",[s._v("inout是可以接受一个参数并输出一个参数")]),s._v(" "),e("div",{staticClass:"language-mysql line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("DELIMITER //\n CREATE PROCEDURE GetAllTest(INOUT it_name  VARCHAR(20))\n   BEGIN\n   SELECT realname INTO it_name FROM test WHERE logid=it_name;\n   END //\nDELIMITER ;\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("p",[e("strong",[s._v("调用inout的存储过程")])]),s._v(" "),e("div",{staticClass:"language-mysql line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("/*设置一个参数，@id=5 说明输入的参数为5*/\nSET @id=5;\n/*然后在调用返回输出一个值*/\nCALL d(@id);\n/*显示存储过程*/\nSELECT @id\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("h3",{attrs:{id:"删除存储过程"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#删除存储过程"}},[s._v("#")]),s._v(" 删除存储过程")]),s._v(" "),e("div",{staticClass:"language-mysql line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v(" DROP PROCEDURE GetAllTest;\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("h3",{attrs:{id:"总结-存储过程主要有参数模型-in-out-inout"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#总结-存储过程主要有参数模型-in-out-inout"}},[s._v("#")]),s._v(" 总结：存储过程主要有参数模型 in out inout")]),s._v(" "),e("ul",[e("li",[e("p",[e("strong",[s._v("in")]),s._v(" 是输入参数")])]),s._v(" "),e("li",[e("p",[e("strong",[s._v("out")]),s._v(" 是输出参数")])]),s._v(" "),e("li",[e("p",[s._v("**inout **是输入并输出")])])]),s._v(" "),e("h2",{attrs:{id:"_2-声明变量"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-声明变量"}},[s._v("#")]),s._v(" 2.声明变量")]),s._v(" "),e("p",[s._v("要在存储过程中声明一个变量，可以使用"),e("code",[s._v("DECLARE")]),s._v("语句")]),s._v(" "),e("div",{staticClass:"language-mysql line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("DECLARE total_sale INT DEFAULT 0;\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[e("code",[s._v("total_sale")]),s._v("为变量名，"),e("code",[s._v("INT")]),s._v("指定变量类型，声明一个变量时，默认值为"),e("code",[s._v("NULL")]),s._v("，使用"),e("code",[s._v("DEFAULT")]),s._v("关键字为变量分配默认值，默认值为0")]),s._v(" "),e("h2",{attrs:{id:"_3-变量赋值"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-变量赋值"}},[s._v("#")]),s._v(" 3.变量赋值")]),s._v(" "),e("p",[s._v("可以使用"),e("code",[s._v("SET")]),s._v("语句，为变量赋值")]),s._v(" "),e("div",{staticClass:"language-mysql line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("SET total_sale=10;\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("除了"),e("code",[s._v("SET")]),s._v("语句之外，还可以使用"),e("code",[s._v("SELECT INTO")]),s._v("语句将查询的结果分配给一个变量，参阅以下示例：")]),s._v(" "),e("div",{staticClass:"language-mysql line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("DECLARE total INT DEFAULT 0\n\nSELECT COUNT(*) INTO total\nFROM GetAllTest\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("h3",{attrs:{id:"_3-1变量作用域"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-1变量作用域"}},[s._v("#")]),s._v(" 3.1变量作用域")]),s._v(" "),e("p",[s._v("一个变量有自己的范围(作用域)，它用来定义它的生命周期。 如果在存储过程中声明一个变量，那么当达到存储过程的"),e("code",[s._v("END")]),s._v("语句时，它将超出范围，因此在其它代码块中无法访问。")]),s._v(" "),e("p",[s._v("以"),e("code",[s._v("@")]),s._v("符号开头的变量是会话变量。直到会话结束前它可用和可访问。")]),s._v(" "),e("h2",{attrs:{id:"_4-参数"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4-参数"}},[s._v("#")]),s._v(" 4.参数")]),s._v(" "),e("div",{staticClass:"language-mysql line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("create procedure procedure_name([in/out/inout] 参数名  参数类型)\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("在MySQL中，参数有三种模式："),e("code",[s._v("IN")]),s._v("，"),e("code",[s._v("OUT")]),s._v("或"),e("code",[s._v("INOUT")]),s._v("。")]),s._v(" "),e("ul",[e("li",[e("code",[s._v("IN")]),s._v(" - 是默认模式。在存储过程中定义"),e("code",[s._v("IN")]),s._v("参数时，调用程序必须将参数传递给存储过程。 另外，"),e("code",[s._v("IN")]),s._v("参数的值被保护。这意味着即使在存储过程中更改了"),e("code",[s._v("IN")]),s._v("参数的值，在存储过程结束后仍保留其原始值。换句话说，存储过程只使用"),e("code",[s._v("IN")]),s._v("参数的副本。")]),s._v(" "),e("li",[e("code",[s._v("OUT")]),s._v(" - 可以在存储过程中更改"),e("code",[s._v("OUT")]),s._v("参数的值，并将其更改后新值传递回调用程序。请注意，存储过程在启动时无法访问"),e("code",[s._v("OUT")]),s._v("参数的初始值。")]),s._v(" "),e("li",[e("code",[s._v("INOUT")]),s._v(" - "),e("code",[s._v("INOUT")]),s._v("参数是"),e("code",[s._v("IN")]),s._v("和"),e("code",[s._v("OUT")]),s._v("参数的组合。这意味着调用程序可以传递参数，并且存储过程可以修改"),e("code",[s._v("INOUT")]),s._v("参数并将新值传递回调用程序。")])]),s._v(" "),e("h2",{attrs:{id:"_5-if语句"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_5-if语句"}},[s._v("#")]),s._v(" 5.IF语句")]),s._v(" "),e("p",[s._v("示例如下：")]),s._v(" "),e("div",{staticClass:"language-mysql line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("IF id=10 THEN \n   SET name='一二三';\nELSEIF id=20 THEN\n\tSET name='四五六';\nEND IF;\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("h2",{attrs:{id:"_6-case语句"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_6-case语句"}},[s._v("#")]),s._v(" 6.CASE语句")]),s._v(" "),e("div",{staticClass:"language-mysql line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("CASE  class_name -- 条件开始\n   WHEN when_expression_1 THEN commands\n   WHEN when_expression_2 THEN commands\n   ELSE commands\nEND CASE; -- 条件结束\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("p",[e("code",[s._v("case_expression")]),s._v("可以是任何有效的表达式。我们将"),e("code",[s._v("case_expression")]),s._v("的值与每个"),e("code",[s._v("WHEN")]),s._v("子句中的"),e("code",[s._v("when_expression")]),s._v("进行比较，例如"),e("code",[s._v("when_expression_1")]),s._v("，"),e("code",[s._v("when_expression_2")]),s._v("等。如果"),e("code",[s._v("case_expression")]),s._v("和"),e("code",[s._v("when_expression_n")]),s._v("的值相等，则执行相应的"),e("code",[s._v("WHEN")]),s._v("分支中的命令("),e("code",[s._v("commands")]),s._v(")。")]),s._v(" "),e("h2",{attrs:{id:"_7-示例"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_7-示例"}},[s._v("#")]),s._v(" 7.示例")]),s._v(" "),e("p",[s._v("一个不完整的示例")]),s._v(" "),e("div",{staticClass:"language-mysql line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('DELIMITER //\n\t# 同步更新\n CREATE PROCEDURE update_realname_phone_cardno(IN in_logid INT,IN in_realname VARCHAR(20),IN in_ifconfirmed INT,IN in_phone VARCHAR(20),IN in_cardno VARCHAR(20))\n   BEGIN\n\t#声明变量\n\tDECLARE rid INT DEFAULT 0; #真实姓名ID\n\tDECLARE cid INT DEFAULT 0; #身份证号ID\n\tDECLARE pid INT DEFAULT 0; #手机ID\n\t\t# 获取id\n   SELECT  realnameid,cardnoid,phoneid\n   INTO rid,cid,pid FROM csr_user WHERE logid=in_logid;\n\n\t IF rid=0 THEN\n\t\tINSERT INTO \n\t ELSE\n\t\tSELECT "已存在";\n\t END IF;\n\t\tUPDATE csr_user SET ifconfirmed=in_ifconfirmed WHERE logid=in_logid;\n   END //\nDELIMITER ;\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br")])]),e("h2",{attrs:{id:"_8-事务"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_8-事务"}},[s._v("#")]),s._v(" 8.事务")]),s._v(" "),e("p",[s._v("在处理事务时，使用SQLException捕获SQL错误，判断是回滚(ROLLBACK)还是提交(COMMIT)，关键代码如下：")]),s._v(" "),e("div",{staticClass:"language-mysql line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("DECLARE c_err INTEGER DEFAULT 0;    #声明捕获SQL错误的变量的初始化\nDECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET c_err=1; #捕获SQL错误同时赋值\n START TRANSACTION;    \n            INSERT INTO test VALUES(NULL, '测试');       \n            INSERT INTO test VALUES('1', '测试');       \n    \n        IF c_err = 1 THEN    \n            ROLLBACK;    \n        ELSE    \n            COMMIT;    \nEND IF;\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br")])])])}),[],!1,null,null,null);a.default=t.exports}}]);